version: '3.7'

services:
  postgresdb:
    image: postgres:latest
    # File-based secrets â€” these files MUST exist in the same directory
    secrets:
      - db_username
      - db_password
    environment:
      POSTGRES_USER_FILE: /run/secrets/db_username
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password

  centos:
    image: centos:7
    deploy:
      replicas: 1
    entrypoint: /bin/sh
    stdin_open: true
    tty: true
    # CLI based secret - must be created manually before deploying the stack
    # docker secret create os_secret -
    secrets:
      - source: os_secret

  wordpress:
    image: wordpress
    ports:
      - "9090:80"
    volumes:
      - wp_data:/var/www/html
    networks:
      - wordpress-network
    # CLI based secret - must be created manually before deploying the stack
    secrets:
      - MYSQL_USER
      - MYSQL_PASSWORD
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER_FILE: /run/secrets/MYSQL_USER
      WORDPRESS_DB_PASSWORD_FILE: /run/secrets/MYSQL_PASSWORD
    deploy:
      replicas: 3
      placement:
        constraints:
          - node.role == worker
    depends_on:
      - db

  db:
    image: mysql:5.6
    volumes:
      - db_data:/var/lib/mysql/
    networks:
      - wordpress-network
    # CLI based secrets - must be created before deploying the stack
    secrets:
      - MYSQL_PASSWORD
      - MYSQL_ROOT_PASSWORD
      - MYSQL_USER
    environment:
      MYSQL_USER_FILE: /run/secrets/MYSQL_USER
      MYSQL_PASSWORD_FILE: /run/secrets/MYSQL_PASSWORD
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/MYSQL_ROOT_PASSWORD
      MYSQL_DATABASE: wordpress
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == worker

volumes:
  wp_data:
  db_data:

networks:
  wordpress-network:
    driver: overlay

secrets:
  # File based secrets
  # db_password and db_username files must be present in the same directory
  # postgresdb
  db_username:
    file: ./db_username
  db_password:
    file: ./db_password

  # CLI based secret - must be created before deploying the stack
  # Centos
  os_secret:
    external: true

  # Wordpress and Mysql  
  MYSQL_PASSWORD:
    external: true
  MYSQL_ROOT_PASSWORD:
    external: true
  MYSQL_USER:
    external: true