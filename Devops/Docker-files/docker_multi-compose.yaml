# -----------------------------------------------------------------------------
# Resource   : Docker Swarm Stack â€“ Example Voting Application
# Purpose    : Deploy a microservices-based voting application consisting of:
#              - Vote UI (Frontend)
#              - Result UI (Backend)
#              - Redis (Frontend cache)
#              - PostgreSQL DB (Backend database)
#              - Worker (Bridges frontend votes to backend storage)
#
# Components :
#    - Redis (redis:alpine)
#         > Acts as an in-memory queue to store incoming votes
#         > Attached to `frontend` overlay network
#
#    - PostgreSQL 15 (Database Service)
#         > Stores final processed vote results
#         > Persistent storage using named volume `db-data`
#         > Attached to `backend` overlay network
#
#    - Vote UI (dockersamples/examplevotingapp_vote)
#         > Web frontend for submitting votes
#         > Exposes port 8080 on the cluster (Routing Mesh)
#         > Connected to `frontend` network
#         > Scaled to 2 replicas for redundancy
#
#    - Result UI (dockersamples/examplevotingapp_result)
#         > Displays voting results in real time
#         > Exposes port 8081 on the cluster
#         > Connected to `backend` network
#
#    - Worker (dockersamples/examplevotingapp_worker)
#         > Consumes votes from Redis and writes them into PostgreSQL
#         > Attached to BOTH networks (frontend + backend)
#         > Scaled to 2 replicas for resiliency
#
# Networking :
#    - frontend (Overlay Network)
#         > For vote UI + Redis + Worker
#         > Handles all traffic related to capturing votes
#
#    - backend (Overlay Network)
#         > For Result UI + PostgreSQL + Worker
#         > Handles final storage + result display processing
#
# Storage    :
#    - db-data (Named Volume)
#         > Ensures PostgreSQL data persistence even after container restarts
#
# Deployment :
#    - Deploy using:
#          docker stack deploy -c docker-compose.yaml myweb
#    - Swarm scheduler distributes services across nodes automatically
#
# Notes      :
#    - No container_name field (not supported in Swarm Mode)
#    - Worker service connects both networks to transfer votes from cache to DB
#    - Ports exposed only for Vote (8080) and Result (8081) for external access
# -----------------------------------------------------------------------------

services:

  redis:
    image: redis:alpine
    networks:
      - frontend

  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "postgres"
    volumes:
      - db-data:/var/lib/postgresql/data
    networks:
      - backend

  vote:
    image: dockersamples/examplevotingapp_vote
    ports:
      - 8080:80
    networks:
      - frontend
    deploy:
      replicas: 2

  result:
    image: dockersamples/examplevotingapp_result
    ports:
      - 8081:80
    networks:
      - backend

  worker:
    image: dockersamples/examplevotingapp_worker
    networks:
      - frontend
      - backend
    deploy:
      replicas: 2

networks:
  frontend:
  backend:

volumes:
  db-data: